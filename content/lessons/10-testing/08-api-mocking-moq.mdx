---
title: "API Mocking with Moq"
description: "Learn to mock HTTP responses for isolated, fast, and reliable API tests"
order: 8
difficulty: "intermediate"
tags: ["mocking", "moq", "unit-testing", "dependency-injection", "isolation"]
duration: "45 minutes"
---

# API Mocking with Moq

When testing code that calls APIs, you don't always want to hit the real API. Mocking lets you simulate API responses for fast, reliable, and isolated tests.

## Prerequisites

‚ö†Ô∏è **ADVANCED LESSON** - Requires solid understanding of OOP, interfaces, and dependency injection.

**Required lessons:**
- ‚úÖ 01-fundamentals (complete section)
- ‚úÖ 02-oop-basics (all 6 lessons including interfaces)
- ‚úÖ 02-oop-basics/06-dependency-injection (**CRITICAL** - mocking requires DI understanding)
- ‚úÖ 03-oop-advanced/03-interfaces (interface implementation)
- ‚úÖ 06-modern-csharp/01-async-await (`Task<T>` and async operations)
- ‚úÖ 09-generics/01-generic-classes (`Mock<T>` uses generics)
- ‚úÖ 11-working-with-json/02-json-serialization
- ‚úÖ 10-testing/03-writing-first-tests
- ‚úÖ 10-testing/07-http-client-testing

**What you need to know:**
- Dependency injection pattern (constructor injection)
- Interfaces and why they enable testing
- Generic types (`Mock<T>`)
- async/await and `Task<T>`
- JSON serialization
- Lambda expressions (x => x.Method())

‚è±Ô∏è **If starting from scratch:** Complete fundamentals + OOP + interfaces + DI + async + generics = ~12-15 hours, then return here.

**üí° TIP:** If dependency injection is new to you, spend extra time on lesson 02-oop-basics/06-dependency-injection before continuing!

## Why Mock API Calls?

### Problems with Real API Calls in Tests

<CodeEditor
  initialCode={`using System;

class WhyMocking
{
    static void Main()
    {
        Console.WriteLine("=== Problems with Real API Calls in Tests ===\\n");
        
        Console.WriteLine("‚ùå SLOW");
        Console.WriteLine("   - Network requests take 100ms-2000ms each");
        Console.WriteLine("   - 100 tests = 1-3 minutes wait time\\n");
        
        Console.WriteLine("‚ùå UNRELIABLE");
        Console.WriteLine("   - API might be down");
        Console.WriteLine("   - Network issues cause flaky tests");
        Console.WriteLine("   - Rate limiting blocks your tests\\n");
        
        Console.WriteLine("‚ùå DEPENDENCIES");
        Console.WriteLine("   - Need internet connection");
        Console.WriteLine("   - CI/CD pipelines may not have access\\n");
        
        Console.WriteLine("‚ùå UNCONTROLLABLE");
        Console.WriteLine("   - Can't test error scenarios easily");
        Console.WriteLine("   - Data changes between test runs\\n");
        
        Console.WriteLine("=== Benefits of Mocking ===\\n");
        
        Console.WriteLine("‚úì FAST - Tests run in milliseconds");
        Console.WriteLine("‚úì RELIABLE - No network dependencies");
        Console.WriteLine("‚úì CONTROLLABLE - Test any scenario");
        Console.WriteLine("‚úì ISOLATED - Test your code, not the API");
    }
}`}
/>

## Setting Up Moq

### Install Required Packages

```bash
dotnet add package Moq
dotnet add package Moq.Contrib.HttpClient
```

### Understanding Interfaces for Mocking

To mock effectively, you need to understand interfaces and dependency injection.

<CodeEditor
  initialCode={`using System;
using System.Threading.Tasks;

// BAD: Hard to test - directly creates HttpClient
public class BadUserService
{
    private readonly System.Net.Http.HttpClient _client = new();
    
    public async Task<string> GetUserName(int id)
    {
        // Can't mock this - it always calls the real API!
        var response = await _client.GetAsync($"https://api.example.com/users/{id}");
        return await response.Content.ReadAsStringAsync();
    }
}

// GOOD: Easy to test - accepts HttpClient via constructor
public class GoodUserService
{
    private readonly System.Net.Http.HttpClient _client;
    
    public GoodUserService(System.Net.Http.HttpClient client)
    {
        _client = client;  // Inject dependency - can be mocked!
    }
    
    public async Task<string> GetUserName(int id)
    {
        var response = await _client.GetAsync($"users/{id}");
        return await response.Content.ReadAsStringAsync();
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("Dependency Injection enables mocking!");
        Console.WriteLine();
        Console.WriteLine("‚ùå Bad: new HttpClient() inside class");
        Console.WriteLine("‚úì Good: HttpClient passed via constructor");
    }
}`}
/>

## Creating Mockable Services

### Step 1: Define an Interface

<CodeEditor
  initialCode={`using System;
using System.Collections.Generic;
using System.Threading.Tasks;

// Step 1: Define what your API client should do
public interface IApiClient
{
    Task<User> GetUserAsync(int id);
    Task<List<User>> GetAllUsersAsync();
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> DeleteUserAsync(int id);
}

public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

public class CreateUserRequest
{
    public string Name { get; set; }
    public string Email { get; set; }
}

// Step 2: Create the real implementation
public class ApiClient : IApiClient
{
    private readonly System.Net.Http.HttpClient _httpClient;
    
    public ApiClient(System.Net.Http.HttpClient httpClient)
    {
        _httpClient = httpClient;
    }
    
    public async Task<User> GetUserAsync(int id)
    {
        // Real HTTP call
        var response = await _httpClient.GetAsync($"users/{id}");
        // Deserialize and return...
        throw new NotImplementedException();
    }
    
    public async Task<List<User>> GetAllUsersAsync()
    {
        throw new NotImplementedException();
    }
    
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        throw new NotImplementedException();
    }
    
    public async Task<bool> DeleteUserAsync(int id)
    {
        throw new NotImplementedException();
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("Interface allows us to create mock implementations!");
    }
}`}
/>

### Step 2: Create a Service That Uses the Interface

<CodeEditor
  initialCode={`using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

public interface IApiClient
{
    Task<User> GetUserAsync(int id);
    Task<List<User>> GetAllUsersAsync();
}

public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public bool IsActive { get; set; }
}

// Service that depends on IApiClient (can be mocked!)
public class UserManager
{
    private readonly IApiClient _apiClient;
    
    public UserManager(IApiClient apiClient)
    {
        _apiClient = apiClient;  // Dependency injection
    }
    
    public async Task<string> GetUserDisplayName(int id)
    {
        User user = await _apiClient.GetUserAsync(id);
        
        if (user == null)
            return "Unknown User";
            
        return $"{user.Name} ({user.Email})";
    }
    
    public async Task<List<User>> GetActiveUsers()
    {
        List<User> allUsers = await _apiClient.GetAllUsersAsync();
        return allUsers.Where(u => u.IsActive).ToList();
    }
    
    public async Task<int> CountUsers()
    {
        List<User> users = await _apiClient.GetAllUsersAsync();
        return users.Count;
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("UserManager depends on IApiClient interface");
        Console.WriteLine("In tests, we can mock IApiClient!");
    }
}`}
/>

## Mocking with Moq - Basics

<CodeEditor
  initialCode={`using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
// using Moq;  // Add in real project
// using Xunit;

public interface IApiClient
{
    Task<User> GetUserAsync(int id);
    Task<List<User>> GetAllUsersAsync();
}

public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public bool IsActive { get; set; }
}

public class UserManager
{
    private readonly IApiClient _apiClient;
    
    public UserManager(IApiClient apiClient)
    {
        _apiClient = apiClient;
    }
    
    public async Task<string> GetUserDisplayName(int id)
    {
        User user = await _apiClient.GetUserAsync(id);
        if (user == null) return "Unknown User";
        return $"{user.Name} ({user.Email})";
    }
    
    public async Task<List<User>> GetActiveUsers()
    {
        List<User> allUsers = await _apiClient.GetAllUsersAsync();
        return allUsers.Where(u => u.IsActive).ToList();
    }
}

// === TESTS WITH MOQT (Conceptual - syntax shown in comments) ===
public class UserManagerTests
{
    // Moq syntax example:
    // var mockApiClient = new Mock<IApiClient>();
    
    // Setup return value:
    // mockApiClient
    //     .Setup(x => x.GetUserAsync(1))
    //     .ReturnsAsync(new User { Id = 1, Name = "Alice", Email = "alice@test.com" });
    
    // Use the mock:
    // var userManager = new UserManager(mockApiClient.Object);
    
    // Test:
    // var result = await userManager.GetUserDisplayName(1);
    // Assert.Equal("Alice (alice@test.com)", result);
    
    public async Task GetUserDisplayName_ValidId_ReturnsFormattedName()
    {
        // This shows the CONCEPT - real Moq code below
        Console.WriteLine("Test: GetUserDisplayName with mocked API");
        Console.WriteLine();
        Console.WriteLine("// Arrange");
        Console.WriteLine("var mock = new Mock<IApiClient>();");
        Console.WriteLine("mock.Setup(x => x.GetUserAsync(1))");
        Console.WriteLine("    .ReturnsAsync(new User { Name = \\"Alice\\", Email = \\"a@b.com\\" });");
        Console.WriteLine();
        Console.WriteLine("var manager = new UserManager(mock.Object);");
        Console.WriteLine();
        Console.WriteLine("// Act");
        Console.WriteLine("var result = await manager.GetUserDisplayName(1);");
        Console.WriteLine();
        Console.WriteLine("// Assert");
        Console.WriteLine("Assert.Equal(\\"Alice (a@b.com)\\", result);");
        
        await Task.CompletedTask;
    }
}

class Program
{
    static async Task Main()
    {
        var tests = new UserManagerTests();
        await tests.GetUserDisplayName_ValidId_ReturnsFormattedName();
    }
}`}
/>

## Complete Moq Examples

### Example 1: Mocking Simple Return Values

<CodeEditor
  initialCode={`using System;
using System.Threading.Tasks;
using Xunit;
// using Moq;  // Install: dotnet add package Moq

public interface IUserRepository
{
    Task<User> GetByIdAsync(int id);
    Task<User> GetByEmailAsync(string email);
    Task<bool> ExistsAsync(int id);
}

public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

public class UserService
{
    private readonly IUserRepository _repository;
    
    public UserService(IUserRepository repository)
    {
        _repository = repository;
    }
    
    public async Task<string> GetGreeting(int userId)
    {
        var user = await _repository.GetByIdAsync(userId);
        if (user == null)
            return "Hello, Guest!";
        return $"Hello, {user.Name}!";
    }
    
    public async Task<bool> IsEmailTaken(string email)
    {
        var user = await _repository.GetByEmailAsync(email);
        return user != null;
    }
}

// Test examples (conceptual - showing Moq patterns)
public class UserServiceTests
{
    /*
    [Fact]
    public async Task GetGreeting_ExistingUser_ReturnsPersonalizedGreeting()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(r => r.GetByIdAsync(1))
                .ReturnsAsync(new User { Id = 1, Name = "Alice" });
        
        var service = new UserService(mockRepo.Object);
        
        // Act
        var result = await service.GetGreeting(1);
        
        // Assert
        Assert.Equal("Hello, Alice!", result);
    }
    
    [Fact]
    public async Task GetGreeting_NonExistentUser_ReturnsGuestGreeting()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(r => r.GetByIdAsync(999))
                .ReturnsAsync((User)null);  // Return null
        
        var service = new UserService(mockRepo.Object);
        
        // Act
        var result = await service.GetGreeting(999);
        
        // Assert
        Assert.Equal("Hello, Guest!", result);
    }
    
    [Fact]
    public async Task IsEmailTaken_ExistingEmail_ReturnsTrue()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(r => r.GetByEmailAsync("alice@test.com"))
                .ReturnsAsync(new User { Email = "alice@test.com" });
        
        var service = new UserService(mockRepo.Object);
        
        // Act
        var result = await service.IsEmailTaken("alice@test.com");
        
        // Assert
        Assert.True(result);
    }
    */
}

class Program
{
    static void Main()
    {
        Console.WriteLine("=== Moq Setup Patterns ===\\n");
        
        Console.WriteLine("1. Return a specific value:");
        Console.WriteLine("   mock.Setup(x => x.Method()).Returns(value);\\n");
        
        Console.WriteLine("2. Return async value:");
        Console.WriteLine("   mock.Setup(x => x.MethodAsync()).ReturnsAsync(value);\\n");
        
        Console.WriteLine("3. Return null:");
        Console.WriteLine("   mock.Setup(x => x.Method()).Returns((User)null);\\n");
        
        Console.WriteLine("4. Match any argument:");
        Console.WriteLine("   mock.Setup(x => x.Method(It.IsAny<int>())).Returns(value);\\n");
        
        Console.WriteLine("5. Match specific argument:");
        Console.WriteLine("   mock.Setup(x => x.Method(42)).Returns(value);");
    }
}`}
/>

### Example 2: Mocking with Argument Matching

<CodeEditor
  initialCode={`using System;
using System.Collections.Generic;
using System.Threading.Tasks;
// using Moq;

public interface IProductApi
{
    Task<Product> GetProductAsync(int id);
    Task<List<Product>> SearchAsync(string query, int maxResults);
    Task<List<Product>> GetByCategoryAsync(string category);
}

public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public string Category { get; set; }
}

public class ProductService
{
    private readonly IProductApi _api;
    
    public ProductService(IProductApi api)
    {
        _api = api;
    }
    
    public async Task<decimal> GetPrice(int productId)
    {
        var product = await _api.GetProductAsync(productId);
        return product?.Price ?? 0;
    }
    
    public async Task<int> CountSearchResults(string query)
    {
        var products = await _api.SearchAsync(query, 100);
        return products.Count;
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("=== Moq Argument Matching ===\\n");
        
        Console.WriteLine("It.IsAny<T>() - Match ANY value of type T");
        Console.WriteLine("  mock.Setup(x => x.GetProduct(It.IsAny<int>()))");
        Console.WriteLine("       .Returns(product);\\n");
        
        Console.WriteLine("It.Is<T>(predicate) - Match if predicate is true");
        Console.WriteLine("  mock.Setup(x => x.GetProduct(It.Is<int>(id => id > 0)))");
        Console.WriteLine("       .Returns(product);\\n");
        
        Console.WriteLine("It.IsIn<T>(values) - Match if value is in list");
        Console.WriteLine("  mock.Setup(x => x.GetProduct(It.IsIn(1, 2, 3)))");
        Console.WriteLine("       .Returns(product);\\n");
        
        Console.WriteLine("It.IsInRange<T>(min, max) - Match if in range");
        Console.WriteLine("  mock.Setup(x => x.GetProduct(It.IsInRange(1, 100, Range.Inclusive)))");
        Console.WriteLine("       .Returns(product);\\n");
        
        Console.WriteLine("It.IsRegex(pattern) - Match string by regex");
        Console.WriteLine("  mock.Setup(x => x.Search(It.IsRegex(\\"^test.*\\")))");
        Console.WriteLine("       .Returns(results);");
    }
}`}
/>

### Example 3: Mocking Exceptions

<CodeEditor
  initialCode={`using System;
using System.Net.Http;
using System.Threading.Tasks;
// using Moq;
// using Xunit;

public interface IPaymentGateway
{
    Task<PaymentResult> ProcessPaymentAsync(decimal amount, string cardNumber);
}

public class PaymentResult
{
    public bool Success { get; set; }
    public string TransactionId { get; set; }
    public string ErrorMessage { get; set; }
}

public class PaymentService
{
    private readonly IPaymentGateway _gateway;
    
    public PaymentService(IPaymentGateway gateway)
    {
        _gateway = gateway;
    }
    
    public async Task<string> Pay(decimal amount, string cardNumber)
    {
        try
        {
            var result = await _gateway.ProcessPaymentAsync(amount, cardNumber);
            
            if (result.Success)
                return $"Payment successful: {result.TransactionId}";
            else
                return $"Payment failed: {result.ErrorMessage}";
        }
        catch (HttpRequestException)
        {
            return "Payment service unavailable. Please try again.";
        }
        catch (TimeoutException)
        {
            return "Payment timed out. Please try again.";
        }
    }
}

// Test examples showing how to mock exceptions
class Program
{
    static void Main()
    {
        Console.WriteLine("=== Mocking Exceptions ===\\n");
        
        Console.WriteLine("Throw exception:");
        Console.WriteLine("  mock.Setup(x => x.Method())");
        Console.WriteLine("      .Throws(new HttpRequestException());\\n");
        
        Console.WriteLine("Throw async exception:");
        Console.WriteLine("  mock.Setup(x => x.MethodAsync())");
        Console.WriteLine("      .ThrowsAsync(new TimeoutException());\\n");
        
        Console.WriteLine("Example test:");
        Console.WriteLine("  [Fact]");
        Console.WriteLine("  public async Task Pay_ServiceUnavailable_ReturnsErrorMessage()");
        Console.WriteLine("  {");
        Console.WriteLine("      var mock = new Mock<IPaymentGateway>();");
        Console.WriteLine("      mock.Setup(x => x.ProcessPaymentAsync(");
        Console.WriteLine("              It.IsAny<decimal>(), It.IsAny<string>()))");
        Console.WriteLine("          .ThrowsAsync(new HttpRequestException());");
        Console.WriteLine();
        Console.WriteLine("      var service = new PaymentService(mock.Object);");
        Console.WriteLine("      var result = await service.Pay(100, \\"1234\\");");
        Console.WriteLine();
        Console.WriteLine("      Assert.Contains(\\"unavailable\\", result);");
        Console.WriteLine("  }");
    }
}`}
/>

### Example 4: Verifying Method Calls

<CodeEditor
  initialCode={`using System;
using System.Threading.Tasks;
// using Moq;
// using Xunit;

public interface IEmailService
{
    Task SendEmailAsync(string to, string subject, string body);
    Task SendWelcomeEmailAsync(string to, string userName);
}

public interface IAuditLogger
{
    void Log(string action, string details);
    void LogError(string error);
}

public class RegistrationService
{
    private readonly IEmailService _emailService;
    private readonly IAuditLogger _logger;
    
    public RegistrationService(IEmailService emailService, IAuditLogger logger)
    {
        _emailService = emailService;
        _logger = logger;
    }
    
    public async Task RegisterUser(string email, string name)
    {
        // Log the registration
        _logger.Log("UserRegistration", $"Registering {email}");
        
        // Send welcome email
        await _emailService.SendWelcomeEmailAsync(email, name);
        
        // Log success
        _logger.Log("UserRegistration", $"Completed for {email}");
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("=== Verifying Method Calls ===\\n");
        
        Console.WriteLine("Verify method was called:");
        Console.WriteLine("  mock.Verify(x => x.Method(), Times.Once());\\n");
        
        Console.WriteLine("Verify with specific arguments:");
        Console.WriteLine("  mock.Verify(x => x.SendEmail(\\"test@test.com\\", ");
        Console.WriteLine("      It.IsAny<string>(), It.IsAny<string>()));\\n");
        
        Console.WriteLine("Times options:");
        Console.WriteLine("  Times.Once()      - Exactly once");
        Console.WriteLine("  Times.Never()     - Never called");
        Console.WriteLine("  Times.Exactly(n)  - Exactly n times");
        Console.WriteLine("  Times.AtLeast(n)  - At least n times");
        Console.WriteLine("  Times.AtMost(n)   - At most n times");
        Console.WriteLine("  Times.Between(m,n) - Between m and n times\\n");
        
        Console.WriteLine("Example test:");
        Console.WriteLine("  [Fact]");
        Console.WriteLine("  public async Task RegisterUser_SendsWelcomeEmail()");
        Console.WriteLine("  {");
        Console.WriteLine("      var mockEmail = new Mock<IEmailService>();");
        Console.WriteLine("      var mockLogger = new Mock<IAuditLogger>();");
        Console.WriteLine();
        Console.WriteLine("      var service = new RegistrationService(");
        Console.WriteLine("          mockEmail.Object, mockLogger.Object);");
        Console.WriteLine();
        Console.WriteLine("      await service.RegisterUser(\\"alice@test.com\\", \\"Alice\\");");
        Console.WriteLine();
        Console.WriteLine("      // Verify email was sent");
        Console.WriteLine("      mockEmail.Verify(x => x.SendWelcomeEmailAsync(");
        Console.WriteLine("          \\"alice@test.com\\", \\"Alice\\"), Times.Once());");
        Console.WriteLine();
        Console.WriteLine("      // Verify logging happened");
        Console.WriteLine("      mockLogger.Verify(x => x.Log(");
        Console.WriteLine("          \\"UserRegistration\\", It.IsAny<string>()), Times.Exactly(2));");
        Console.WriteLine("  }");
    }
}`}
/>

## Mocking HttpClient with HttpMessageHandler

<CodeEditor
  initialCode={`using System;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
// using Moq;
// using Moq.Protected;
// using Xunit;

public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

public class UserApiClient
{
    private readonly HttpClient _client;
    private readonly JsonSerializerOptions _jsonOptions;
    
    public UserApiClient(HttpClient client)
    {
        _client = client;
        _jsonOptions = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
    }
    
    public async Task<User> GetUserAsync(int id)
    {
        var response = await _client.GetAsync($"users/{id}");
        
        if (!response.IsSuccessStatusCode)
            return null;
            
        var json = await response.Content.ReadAsStringAsync();
        return JsonSerializer.Deserialize<User>(json, _jsonOptions);
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine("=== Mocking HttpClient ===\\n");
        
        Console.WriteLine("HttpClient uses HttpMessageHandler internally.");
        Console.WriteLine("We mock the handler to control responses.\\n");
        
        Console.WriteLine("Pattern:");
        Console.WriteLine("  var mockHandler = new Mock<HttpMessageHandler>();");
        Console.WriteLine();
        Console.WriteLine("  mockHandler.Protected()");
        Console.WriteLine("      .Setup<Task<HttpResponseMessage>>(");
        Console.WriteLine("          \\"SendAsync\\",");
        Console.WriteLine("          ItExpr.IsAny<HttpRequestMessage>(),");
        Console.WriteLine("          ItExpr.IsAny<CancellationToken>())");
        Console.WriteLine("      .ReturnsAsync(new HttpResponseMessage");
        Console.WriteLine("      {");
        Console.WriteLine("          StatusCode = HttpStatusCode.OK,");
        Console.WriteLine("          Content = new StringContent(json)");
        Console.WriteLine("      });");
        Console.WriteLine();
        Console.WriteLine("  var client = new HttpClient(mockHandler.Object);");
        Console.WriteLine("  var apiClient = new UserApiClient(client);\\n");
        
        Console.WriteLine("Benefits:");
        Console.WriteLine("  ‚úì Full control over HTTP responses");
        Console.WriteLine("  ‚úì Test error scenarios (500, 404, timeouts)");
        Console.WriteLine("  ‚úì No network calls - fast tests");
    }
}`}
/>

## Complete Mocking Test Class

<CodeEditor
  initialCode={`using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
// using Moq;
// using Xunit;

// Interfaces
public interface IUserApi
{
    Task<User> GetUserAsync(int id);
    Task<List<User>> GetAllUsersAsync();
    Task<User> CreateUserAsync(string name, string email);
}

public interface INotificationService
{
    Task SendNotificationAsync(int userId, string message);
}

// Models
public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

// Service under test
public class UserManagementService
{
    private readonly IUserApi _userApi;
    private readonly INotificationService _notifications;
    
    public UserManagementService(IUserApi userApi, INotificationService notifications)
    {
        _userApi = userApi;
        _notifications = notifications;
    }
    
    public async Task<string> GetUserSummary(int id)
    {
        var user = await _userApi.GetUserAsync(id);
        if (user == null) return "User not found";
        return $"{user.Name} - {user.Email}";
    }
    
    public async Task<int> GetActiveUserCount()
    {
        var users = await _userApi.GetAllUsersAsync();
        return users?.Count ?? 0;
    }
    
    public async Task<User> RegisterAndNotify(string name, string email)
    {
        var user = await _userApi.CreateUserAsync(name, email);
        await _notifications.SendNotificationAsync(user.Id, "Welcome!");
        return user;
    }
}

// Comprehensive test class
public class UserManagementServiceTests
{
    /*
    private readonly Mock<IUserApi> _mockUserApi;
    private readonly Mock<INotificationService> _mockNotifications;
    private readonly UserManagementService _service;
    
    public UserManagementServiceTests()
    {
        _mockUserApi = new Mock<IUserApi>();
        _mockNotifications = new Mock<INotificationService>();
        _service = new UserManagementService(_mockUserApi.Object, _mockNotifications.Object);
    }
    
    [Fact]
    public async Task GetUserSummary_ExistingUser_ReturnsFormattedSummary()
    {
        // Arrange
        _mockUserApi.Setup(x => x.GetUserAsync(1))
            .ReturnsAsync(new User { Id = 1, Name = "Alice", Email = "alice@test.com" });
        
        // Act
        var result = await _service.GetUserSummary(1);
        
        // Assert
        Assert.Equal("Alice - alice@test.com", result);
    }
    
    [Fact]
    public async Task GetUserSummary_NonExistentUser_ReturnsNotFound()
    {
        // Arrange
        _mockUserApi.Setup(x => x.GetUserAsync(999))
            .ReturnsAsync((User)null);
        
        // Act
        var result = await _service.GetUserSummary(999);
        
        // Assert
        Assert.Equal("User not found", result);
    }
    
    [Fact]
    public async Task GetActiveUserCount_ReturnsCorrectCount()
    {
        // Arrange
        var users = new List<User>
        {
            new User { Id = 1, Name = "Alice" },
            new User { Id = 2, Name = "Bob" },
            new User { Id = 3, Name = "Charlie" }
        };
        _mockUserApi.Setup(x => x.GetAllUsersAsync()).ReturnsAsync(users);
        
        // Act
        var count = await _service.GetActiveUserCount();
        
        // Assert
        Assert.Equal(3, count);
    }
    
    [Fact]
    public async Task GetActiveUserCount_EmptyList_ReturnsZero()
    {
        // Arrange
        _mockUserApi.Setup(x => x.GetAllUsersAsync())
            .ReturnsAsync(new List<User>());
        
        // Act
        var count = await _service.GetActiveUserCount();
        
        // Assert
        Assert.Equal(0, count);
    }
    
    [Fact]
    public async Task RegisterAndNotify_CreatesUserAndSendsNotification()
    {
        // Arrange
        var createdUser = new User { Id = 42, Name = "NewUser", Email = "new@test.com" };
        _mockUserApi.Setup(x => x.CreateUserAsync("NewUser", "new@test.com"))
            .ReturnsAsync(createdUser);
        
        // Act
        var result = await _service.RegisterAndNotify("NewUser", "new@test.com");
        
        // Assert
        Assert.Equal(42, result.Id);
        
        // Verify notification was sent
        _mockNotifications.Verify(
            x => x.SendNotificationAsync(42, "Welcome!"),
            Times.Once());
    }
    */
}

class Program
{
    static void Main()
    {
        Console.WriteLine("=== Complete Mocking Example ===\\n");
        Console.WriteLine("Run tests with: dotnet test\\n");
        
        Console.WriteLine("Test patterns demonstrated:");
        Console.WriteLine("  1. Mocking return values");
        Console.WriteLine("  2. Returning null for not found");
        Console.WriteLine("  3. Returning collections");
        Console.WriteLine("  4. Verifying method calls");
        Console.WriteLine("  5. Multiple mock dependencies");
    }
}`}
/>

## Mocking Best Practices

<CodeEditor
  initialCode={`using System;

class MockingBestPractices
{
    static void Main()
    {
        Console.WriteLine("=== Mocking Best Practices ===\\n");
        
        Console.WriteLine("‚úì DO:");
        Console.WriteLine("  ‚Ä¢ Mock external dependencies (APIs, databases, file system)");
        Console.WriteLine("  ‚Ä¢ Use interfaces for mockable dependencies");
        Console.WriteLine("  ‚Ä¢ Keep mocks simple - only setup what you need");
        Console.WriteLine("  ‚Ä¢ Verify important interactions");
        Console.WriteLine("  ‚Ä¢ Use descriptive test names");
        Console.WriteLine("  ‚Ä¢ Test one behavior per test\\n");
        
        Console.WriteLine("‚úó DON'T:");
        Console.WriteLine("  ‚Ä¢ Mock everything - some things should be real");
        Console.WriteLine("  ‚Ä¢ Over-verify - don't check every method call");
        Console.WriteLine("  ‚Ä¢ Mock value objects (DTOs, models)");
        Console.WriteLine("  ‚Ä¢ Make mocks too complex");
        Console.WriteLine("  ‚Ä¢ Forget to test error scenarios\\n");
        
        Console.WriteLine("=== When to Use Real vs Mock ===\\n");
        
        Console.WriteLine("USE REAL:");
        Console.WriteLine("  ‚Ä¢ Value objects / DTOs");
        Console.WriteLine("  ‚Ä¢ Simple utility classes");
        Console.WriteLine("  ‚Ä¢ In-memory collections");
        Console.WriteLine("  ‚Ä¢ Pure functions\\n");
        
        Console.WriteLine("USE MOCK:");
        Console.WriteLine("  ‚Ä¢ HTTP clients");
        Console.WriteLine("  ‚Ä¢ Database connections");
        Console.WriteLine("  ‚Ä¢ File system access");
        Console.WriteLine("  ‚Ä¢ External services");
        Console.WriteLine("  ‚Ä¢ Time-dependent code");
        Console.WriteLine("  ‚Ä¢ Random number generators");
    }
}`}
/>

## Key Takeaways

- **Mocking** simulates dependencies for isolated, fast tests
- **Interfaces** enable mocking through dependency injection
- **Moq** is the most popular C# mocking framework
- **Setup()** defines what the mock returns
- **Verify()** checks if methods were called
- **It.IsAny&lt;T&gt;()** matches any argument value
- Mock **external dependencies**, not internal logic
- **HttpClient** is mocked via HttpMessageHandler

## Practice Exercises

1. Create an interface for a weather API and mock it
2. Write tests that verify error handling with mocked exceptions
3. Create a service with multiple dependencies and mock all of them
4. Practice verification patterns with Times options
5. Mock an HttpClient to return different responses

## Next Lesson

Put it all together with **real-world API integration testing** - complete end-to-end examples!
